---
title: "Wie schätzt man eine Mehrebenenregression in R?"
subtitle: "Videoserie Mehrebenenregression Teil 3/6"
author: "Dr. Uwe Remer"
date: "Juli 2022"
output:
  html_document:
    toc: yes
    number_sections: yes
    toc_depth: 2
    toc_float:
      collapsed: true
    df_print: paged
    highlight: tango
    theme: spacelab
---

```{r setup, include=FALSE}
# Figure size in inches
w = 5
h = 2.5
s = 2.8
    
knitr::opts_chunk$set(eval=TRUE, echo = FALSE, message = FALSE, warning = FALSE,
                      fig.width=w, fig.height=h, fig.align='center')
save <-  F
save_fig <- function(filename, save = TRUE){
  if(save==TRUE){
    ggsave(paste0("./Grafiken/", filename), 
         width = w, height = h,
         #scale = s,       
         unit = "in")
  }
  else{
    message("Saving skipped...")
  }
}
```

```{css, eval=T}
/* CSS Stil für Formeln unter Scatterplots */
P.math {
    text-align: center;
    font-size: 2vw;
}
```


# Themenüberblick

Hallo und herzlich Willkommen zum dritten Teil der Videoserie zum Thema Mehrebenenregression in R. 



Im vorigen Video haben wir gesehehn, wie man mit Hilfe des sogenannten Nullmodells berechnet, ob eine Mehrebenenregression überhaupt notwendig ist.
Nur wenn dies der Fall ist, werden die eigentlich interessierenden Mehrebenenregressionsmodelle geschätzt.

Und genau darum geht es in diesem ditten Video: Wie schätzt man eine Mehrebenenregression in R? 
Und natürlich: wie interpretiert man die Ergebnisse?

Dazu schauen wir ns zuerst die Operationalisireung der Variablen.
Danach schätzen wir mehrere aufeinander aufbauende Modelle:

- Modell mit variierenden Intercepts mit Prädiktoren auf L1
- Modell mit variierenden Intercepts mit Prädiktoren auf L1 und L2
- Modell mit variierenden Intercepts und variierenden Slopes
- Modell mit variierenden Intercepts und variierenden Slopes und Cross-Level-Interaktionen


Lernziele für dieses Video sind…

- dass Sie die Variablen für das Mehrebenenmodell vorbereiten können:
  - dass Sie wissen wie man Datensätze zussenspielt
  - dass Sie verstehen, warum die unabhängigen Variablen zentriert werden müssen und wissen, wie Sie das in R umsetzen können
- dass Sie unterschiedliche Varianten der Mehrebenenregression als Formel ausdrücken können
- dass Sie wissen, wie man diese unterschiedlichen Varianten in R umsetzt
- dass Sie die relevanten Quantities of Interest kennen und interpretieren können.

Das alles schauen wir uns direkt in R an...


# Operationalisierung

Bevor wir unsere Modelle schätzen können, müssen die Variablen operationalisiert werden. Als Datensatz nutzen wir den ESS 9. Inforamtionen zum Datensatz finden Sie im ersten Video.

Bereits im letzten Video Nr. 2 haben wir die abhängige Variable für unser Beispiel kennengelernt: das politische Vertrauen. 

Den ersten Teil des R-Codes können wir direkt noch Mal nutzen. 

```{r}
# Importieren des Datensatz
library(foreign)
ess <- read.spss("./Daten/ESS9e02.sav", 
                 use.value.labels = FALSE,
                 to.data.frame = TRUE,
                 reencode = TRUE)



# Operationalisierung der abh. Variable 
# "Politisches Vertrauen"
# Mittelwertindex aus drei Items:
idx_vars <- c("trstprl","trstplt","trstprt")
ess$pol_vertrauen <- rowMeans(ess[,idx_vars], 
                              na.rm = F)
#table(ess$pol_vertrauen, useNA = "always")
#DescTools::Desc(ess$pol_vertrauen)
```

Neben der abhängigen Variable benötigen wir auch noch die unabhängigen Variablen



```{r}
#table(ess$cntry)

ess$zufr_wirtschaft <- ess$stfeco
```




## Missing Values ausschließen

Um einen Datensatz zu erhalten, der in über alle Modelle die gleiche Fallzahl aufweist, werden diejenigen Fälle ausgeschlossen, die auf mindestens einer der für die Analysen genutzten variablen fehlende Werte aufweist ("Listenweise Fallausschluss").

```{r Missing_values_ausschließen}
# Missing Values ausschließen
variablen_im_modell <- c("pol_vertrauen",
                         "zufr_wirtschaft",
                         "responsivitaet",
                         "soz_vertrauen", 
                         "bildung", 
                         "cntry",
                         "c_ticpi_2018")
ess <- na.omit(ess[,variablen_im_modell])
```


## Zentrieren

In Mehrebenenmodellen ist es erforderlich, dass die unabhängigen Variablen auf Ebene 1 Mittelwertzentriert werden. Das sog. *Grand-Mean-Centering* sorgt dafür, dass die Referenzkategorie für den Intercept (alle X-Var bei 0) der Grand Mean der abhängien Variable ist.

```{r zentrieren_L!_X-Vars}
# Z_Transformation der Ebene 1 x-Variablen
# Diese sind an 2. bis 5. Stelle im Datensatz
ess_centered <- as.data.frame(scale(ess[,c(2:5,7)]))
ess[,c(2:5,7)] <- ess_centered
```


# Variierenden Intercepts mit Prädiktoren auf L1
# Variierenden Intercepts mit Prädiktoren auf L1 und L2
# Variierenden Intercepts und variierenden Prädiktoren
# Cross-Level-Interaktionen
